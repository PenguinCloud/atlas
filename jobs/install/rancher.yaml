#- name: Deploy latest version of Rancher into the cattle-system namespace
#  community.kubernetes.helm:
#    name: rancher
#    chart_ref: rancher-stable/rancher
#    release_namespace: cattle-system
#    create_namespace: yes
#    release_state: present
#    update_repo_cache: yes
#    wait: yes
#    values:
#      hostname: "{{ cluster.fqdn }}"
- name: Make sure repo is defined right
  command: "helm repo add rancher-latest https://releases.rancher.com/server-charts/latest"
  tags:
    - rancher
- name: update repos
  shell:
    cmd: "helm repo update"
  tags:
    - rancher
- name: create rancher namespace
  community.kubernetes.k8s:
    name: cattle-system
    api_version: v1
    kind: Namespace
    kubeconfig: /root/.kube/config
    state: present

- name: install rancher chart
  block:
    - name: try fresh install
      shell: 
        cmd: "helm install rancher rancher-latest/rancher --namespace cattle-system --set hostname={{ cluster.fqdn }}"
      tags:
        - rancher
  rescue:
    - name: Assume prior installed and try an upgrade install
      shell: 
        cmd: "helm upgrade --install rancher rancher-latest/rancher --namespace cattle-system --set hostname={{ cluster.fqdn }}  --set ingress.tls.source=letsEncrypt --set letsEncrypt.email={{ admin.email }}"
      tags:
        - rancher
- name: wait for install to  complete
  command: "kubectl get pods -n cattle-system"
  register: pod_list 
  tags:
    - rancher
- name: Add more wait time for pods to complete install, it can take many minutes depending on system
  pause:
    minutes: 2
  until: pod_list.stdout.find('Running') >= 3
  when: pod_list.stdout.find('Running') < 3 
  tags:
    - rancher

