---
- stat: path=/etc/kubernetes/manifests/kube-controller-manager.yaml
  register: kube_file
- name: Initialize Primary Control node
  shell: 'kubeadm init --control-plane-endpoint "{{ cluster.ip }}:{{ cluster.port }}" --upload-certs --pod-network-cidr={{ cluster.pod_cidr }} -v=9'
  register: kube_init
  when: primary and k8type=="control" and not kube_file.stat.exists
  tags:
    - primary
    - control
- name: Initialize Secondary Control nodes
  shell: 'kubeadm join {{ cluster.ip }}:{{ cluster.port }} --token {{ k8stoken }} --discovery-token-ca-cert-hash {{ k8shash }} --control-plane'
  register: kube_init
  when: not primary and k8type=="control"
  tags:
    - secondary
    - control
- name: Initialize Worker nodes
  shell: 'kubeadm join {{ cluster.ip }}:{{ cluster.port }} --token {{ k8stoken }} --discovery-token-ca-cert-hash {{ k8shash }}'
  register: kube_init
  when: k8type=="worker"
  tags:
    - worker
- name: results
  debug: 
    var: kube_init
    verbosity: 2
- name: Copy the prior results somewhere... we'll wait a minute
  pause:
    minutes: 1
- name: We'll make a copy just in case
  shell: echo '{{ kube_init.stdout }}' >> ~/mykubeinfo

  
