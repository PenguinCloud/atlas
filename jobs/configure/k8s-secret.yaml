---
- stat: path=/etc/kubernetes/kubelet.conf
  register: kube_file
# See if variable file exists (variable file has two gitignore matches), hopefully we created it after primary build!
- stat: path=/opt/atlas/join-secrets.yml
  register: secret_file
# If exists import these variables... but we will have to split them later!
- name: import vars
  when: kube_file.stat.exists
  include_vars:
    file: /opt/atlas/join-secrets.yml
    name: k8ssecrets

# Now we match these values to facts
- set_fact:
    k8stoken: "{{ k8ssecrets.k8stoken }}"
  when: kube_file.stat.exists
- set_fact:
    k8shash: "{{ k8ssecrets.k8shash }}"
  when: kube_file.stat.exists
- set_fact:
    k8scert: "{{ k8ssecrets.k8scert }}"
  when: kube_file.stat.exists

# Now, if it doesnt exist... we prompt for it and set it!
- pause:
    prompt: "Please enter the value for k8s join token: "
    echo: yes
  register: result
  when: not kube_file.stat.exists and not primary
- set_fact:
    k8stoken: "{{ result.k8stoken }}"
  when: not kube_file.stat.exists and not primary
- pause:
    prompt: "Please enter the value for k8s join hash: "
    echo: yes
  register: result
  when: not kube_file.stat.exists and not primary
- set_fact:
    k8shash: "{{ result.k8shash }}"
  when: not kube_file.stat.exists and not primary
- pause:
    prompt: "Please enter the value for k8s join cert: "
    echo: yes
  register: result
  when: not kube_file.stat.exists and not primary
- set_fact:
    k8scert: "{{ result.k8scert }}"
  when: not kube_file.stat.exists and not primary