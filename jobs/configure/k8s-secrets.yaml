---
- name: Grab Hash
  shell: "openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'"
  register: hash
- name: Grab Cert
  shell:  "kubeadm init phase upload-certs --upload-certs | tail -n 1"
  register: cert
- name: Get Token
  shell: "kubeadm token list | grep -B 0 -i bootstrappers | cut -f 1 -d ' ' | tail -n 1"
  register: token
- name: Add Token
  yedit:
    src: "{{ playbook_dir }}/vars/k8s-secret.yml"
    key: k8stoken
    value: "{{ token.stdout }}"
- name: Add Hash
  yedit:
    src: "{{ playbook_dir }}/vars/k8s-secret.yml"
    key: k8shash
    value: "{{ hash.stdout }}"
- name: Add Cert
  yedit:
    src: "{{ playbook_dir }}/vars/k8s-secret.yml"
    key: k8scert
    value: "{{ cert.stdout }}"