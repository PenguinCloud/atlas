---
- name: Grab Hash
  shell: "openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'"
  register: hash
- name: Grab Cert
  shell:  "kubeadm init phase upload-certs --upload-certs | tail -n 1"
  register: cert
- name: Get Token
  shell: "kubeadm token list | grep -B 0 -i bootstrappers | cut -f 1 -d ' ' | tail -n 1"
  register: token
- name: Give values
  debug:
    msg: "We are using the token {{ token.stdout }}, the hash {{ hash.stdout }}, and the cert of {{ cert.stdout }}"
- name: Add Token
  lineinfile:
    path: "{{ playbook_dir }}/vars/k8s-secret.yml"
    line: "k8stoken: {{ token }}"
    create: yes
- name: Add Hash
  lineinfile:
    path: "{{ playbook_dir }}/vars/k8s-secret.yml"
    line: "k8shash: {{ hash }}"
- name: Add Cert
  lineinfile:
    path: "{{ playbook_dir }}/vars/k8s-secret.yml"
    line: "k8scert: {{ cert }}"