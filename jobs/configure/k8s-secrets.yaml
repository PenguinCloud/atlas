---
- stat: "{{ secretsFile }}"
  register: kube_file
- name: Grab Hash
  shell: "openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'"
  register: hash
  when: not kube_file.stat.exists
- name: Grab Cert
  shell:  "kubeadm init phase upload-certs --upload-certs | tail -n 1"
  register: cert
  when: not kube_file.stat.exists
- name: Get Token
  shell: "kubeadm token list | grep -B 0 -i bootstrappers | cut -f 1 -d ' ' | tail -n 1"
  register: token
  when: not kube_file.stat.exists
#- name: Give values
#  pause:
#    prompt: "We are using the token {{ token.stdout }}, the hash {{ hash.stdout }}, and the cert of {{ cert.stdout }}. Press enter to continue.cd o "
- name: Add Token
  lineinfile:
    path: "{{ secretsFile }}"
    line: "k8stoken: {{ token.stdout_lines[0] }}"
    create: yes
  when: not kube_file.stat.exists
- name: Add Hash
  lineinfile:
    path: "{{ secretsFile }}"
    line: "k8shash: {{ hash.stdout_lines[0] }}"
  when: not kube_file.stat.exists
- name: Add Cert
  lineinfile:
    path: "{{ secretsFile }}"
    line: "k8scert: {{ cert.stdout_lines[0] }}"
  when: not kube_file.stat.exists